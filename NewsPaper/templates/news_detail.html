{% extends 'flatpages/default.html' %}

{% load custom_filters %}
{% load custom_tags %}

{% block title %}
{{ post.title }}
{% endblock title %}

{% block content %}
    <h1>{{ post.title|censor }}</h1>
    
    <div class="post-meta">
        <p><strong>Дата публикации:</strong> {{ post.create_at|date:"d.m.Y" }}</p>
        <p><strong>Автор:</strong> {{ post.author.user.username }}</p>
        <p><strong>Рейтинг:</strong> {{ post.rating }}</p>
        <p><strong>Тип:</strong> {{ post.get_post_type_display }}</p>
    </div>
    
    <div class="post-content">
        <p>{{ post.text|censor }}</p>
    </div>

    <!-- Сообщения об успешных действиях -->
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Блок подписки на категории -->
    <div class="subscription-section mt-4">
        <h3>Категории этой публикации</h3>
        
        {% if post.categories.all %}
            <div class="list-group">
                {% for category in post.categories.all %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>{{ category.name }}</strong></span>
                        
                        {% if user.is_authenticated %}
                            {% if user in category.subscribers.all %}
                                <div>
                                    <span class="text-success mr-2">✓ Подписан</span>
                                    <a href="{% url 'unsubscribe_from_category' category.id %}" 
                                       class="btn btn-outline-danger btn-sm">Отписаться</a>
                                </div>
                            {% else %}
                                <a href="{% url 'subscribe_to_category' category.id %}" 
                                   class="btn btn-success btn-sm">Подписаться</a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'account_login' %}?next={{ request.path }}" 
                               class="btn btn-outline-primary btn-sm">Войти чтобы подписаться</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Ссылка на управление подписками -->
            {% if user.is_authenticated %}
            <div class="mt-3">
                <a href="{% url 'my_subscriptions' %}" class="btn btn-info btn-sm">
                    Управление моими подписками
                </a>
            </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                У этой публикации нет категорий
            </div>
        {% endif %}
    </div>

    <!-- Кнопки редактирования и удаления -->
    <div class="mt-4">
        {% if user.is_authenticated and user|has_group:'premium' and post.author.user == user %}
            {% if post.post_type == 'NW' %}
                <a href="{% url 'news_edit' post.pk %}" class="btn btn-primary">Редактировать новость</a>
                <a href="{% url 'news_delete' post.pk %}" class="btn btn-danger">Удалить новость</a>
            {% else %}
                <a href="{% url 'article_edit' post.pk %}" class="btn btn-primary">Редактировать статью</a>
                <a href="{% url 'article_delete' post.pk %}" class="btn btn-danger">Удалить статью</a>
            {% endif %}
        {% endif %}
        <a href="{% url 'news_list' %}" class="btn btn-secondary">Назад к списку</a>
    </div>
{% endblock content %}